<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>普通話活動室考勤系統</title>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a73e8, #6c8ef5);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 300px;
        }
        
        .panel h2 {
            color: #1a73e8;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
            padding: 12px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #0d62d9;
        }
        
        button.secondary {
            background-color: #5f6368;
        }
        
        button.secondary:hover {
            background-color: #4a4d52;
        }
        
        button.danger {
            background-color: #ea4335;
        }
        
        button.danger:hover {
            background-color: #d32f2f;
        }
        
        button.success {
            background-color: #34a853;
            color: white;
        }
        
        button.success:hover {
            background-color: #2e8b47;
            color: white;
        }
        
        button.warning {
            background-color: #fbbc04;
            color: white;
        }
        
        button.warning:hover {
            background-color: #e6a800;
            color: white;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin: 15px 0;
            text-align: center;
            overflow: hidden;
        }
        
        #interactive {
            width: 100%;
            height: 120px;
            border-radius: 5px;
            background: #000;
            margin: 0 auto;
        }
        
        /* 强制限制扫描窗口内的视频元素尺寸 */
        #interactive video,
        #interactive canvas {
            width: 100% !important;
            height: 120px !important;
            object-fit: cover;
        }
        
        .scan-guide {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        #scan-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background: #f0f7ff;
            border: 1px solid #c2e0ff;
            min-height: 60px;
        }
        
        .record-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        
        .record-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .record-item:first-child {
            background-color: #f0f7ff;
            font-weight: bold;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .session-selector {
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #e6f4ea;
            border: 1px solid #34a853;
            color: #137333;
        }
        
        .error {
            background-color: #fce8e6;
            border: 1px solid #ea4335;
            color: #c5221f;
        }
        
        .info {
            background-color: #e8f0fe;
            border: 1px solid #1a73e8;
            color: #174ea6;
        }
        
        .warning {
            background-color: #fef7e0;
            border: 1px solid #fbbc04;
            color: #e37400;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #5f6368;
            font-size: 14px;
        }
        
        .manual-input {
            margin-top: 15px;
        }
        
        .scanning-active {
            border: 2px solid #1a73e8;
        }
        
        .mapping-config {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .mapping-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .manual-input-format {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .management-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .management-buttons button {
            flex: 1;
            margin-top: 0;
        }
        
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .dialog {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .dialog h3 {
            margin-bottom: 15px;
            color: #1a73e8;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dialog-buttons button {
            flex: 1;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .stats-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .stats-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .stats-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .stats-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        
        .export-stats-btn {
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .management-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>普通話活動室考勤系統</h1>
        <p>學生證條形碼掃描登記 (Code128格式)</p>
    </header>
    
    <div class="container">
        <div class="panel">
            <h2>1. 學生編號映射配置</h2>
            <div class="mapping-config">
                <div class="form-group">
                    <label for="mapping-file">上傳學生編號映射文件 (Excel格式)</label>
                    <input type="file" id="mapping-file" accept=".xlsx, .xls">
                    <div class="mapping-info">
                        <p>Excel文件格式要求：</p>
                        <ul>
                            <li>第一列：學生證號 (8位數字)</li>
                            <li>第二列：班別 (例如: P1A)</li>
                            <li>第三列：學號 (例如: 1)</li>
                        </ul>
                    </div>
                </div>
                <button id="load-mapping" class="secondary">載入映射文件</button>
                <div id="mapping-status" class="mapping-info"></div>
            </div>
            
            <h2>2. 登記考勤</h2>
            <div class="form-group">
                <label for="session-id">本次考勤識別碼</label>
                <input type="text" id="session-id" placeholder="例如：PTH 1202">
            </div>
            
            <button id="start-scan">開始掃描</button>
            <button id="stop-scan" class="secondary hidden">停止掃描</button>
            
            <div id="video-container" class="video-container hidden">
                <div id="interactive"></div>
                <div class="scan-guide">請將學生證條形碼對準掃描框</div>
            </div>
            
            <div id="scan-result"></div>
            
            <div class="manual-input">
                <label for="manual-input">手動輸入</label>
                <input type="text" id="manual-input" placeholder="可輸入學生證號 或 班別 學號 (如: P1A 1)">
                <div class="manual-input-format">支援格式：學生證號 (8位數字) 或 班別+空格+學號 (如: P1A 1)</div>
                <button id="manual-submit" class="secondary">手動登記</button>
            </div>
            
            <div id="attendance-list" class="record-list">
                <div class="status info">暫無考勤記錄</div>
            </div>
        </div>
        
        <div class="panel">
            <h2>3. 考勤記錄</h2>
            <div class="form-group session-selector">
                <label for="session-select">選擇活動</label>
                <select id="session-select">
                    <option value="">-- 選擇活動 --</option>
                </select>
            </div>
            
            <div class="management-buttons">
                <button id="rename-session" class="secondary">重命名活動</button>
                <button id="delete-session" class="danger">刪除活動</button>
            </div>
            
            <div id="records-list" class="record-list">
                <div class="status info">請選擇活動或該活動暫無記錄</div>
            </div>
            
            <div class="management-buttons">
                <button id="cleanup-data" class="warning">清理數據（學號去零 & 去重）</button>
                <button id="export-excel" class="secondary">匯出為Excel</button>
            </div>
            
            <button id="clear-data" class="danger">清除所有數據</button>
            
            <h2 style="margin-top: 30px;">4. 參與次數統計</h2>
            <div class="form-group">
                <label for="stats-file">導入考勤文件 (Excel格式)</label>
                <input type="file" id="stats-file" accept=".xlsx, .xls">
                <div class="mapping-info">
                    <p>導入之前導出的考勤Excel文件，系統將統計每個學生的參與次數</p>
                </div>
            </div>
            <button id="generate-stats" class="success">生成參與次數統計</button>
            
            <div id="stats-result" class="hidden">
                <div class="stats-container" id="stats-container">
                    <div class="status info">暫無統計數據</div>
                </div>
                
                <button id="export-stats" class="export-stats-btn secondary hidden">匯出統計結果</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>普通話活動室考勤系統 &copy; 2025 - Code128條形碼掃描版</p>
    </footer>

    <script>
        // 存儲考勤數據
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let currentSessionId = '';
        let scannedStudents = new Set();
        let isScanning = false;
        let studentMapping = JSON.parse(localStorage.getItem('studentMapping')) || {};
        let reverseMapping = {}; // 反向映射：班別學號 -> 學生證號
        
        // 統計數據
        let statsData = {
            students: {}, // 學生參與次數數據
            sessions: 0,  // 總活動數
            sessionNames: [], // 所有活動名稱
            summary: {}   // 班級統計摘要
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加載已有的活動列表
            updateSessionSelect();
            
            // 開始掃描按鈕事件
            document.getElementById('start-scan').addEventListener('click', startScanner);
            
            // 停止掃描按鈕事件
            document.getElementById('stop-scan').addEventListener('click', stopScanner);
            
            // 手動登記按鈕事件
            document.getElementById('manual-submit').addEventListener('click', manualSubmit);
            
            // 手動輸入框回車事件
            document.getElementById('manual-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    manualSubmit();
                }
            });
            
            // 載入映射文件按鈕事件
            document.getElementById('load-mapping').addEventListener('click', loadMappingFile);
            
            // 匯出Excel按鈕事件
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            
            // 清除數據按鈕事件
            document.getElementById('clear-data').addEventListener('click', clearAllData);
            
            // 清理數據按鈕事件
            document.getElementById('cleanup-data').addEventListener('click', cleanupData);
            
            // 活動選擇變化事件
            document.getElementById('session-select').addEventListener('change', showSessionRecords);
            
            // 重命名活動按鈕事件
            document.getElementById('rename-session').addEventListener('click', renameSession);
            
            // 刪除活動按鈕事件
            document.getElementById('delete-session').addEventListener('click', deleteSession);
            
            // 生成統計按鈕事件
            document.getElementById('generate-stats').addEventListener('click', generateAttendanceStats);
            
            // 匯出統計結果按鈕事件
            document.getElementById('export-stats').addEventListener('click', exportStatsToExcel);
            
            // 更新映射狀態顯示
            updateMappingStatus();
            updateReverseMapping();
        });
        
        // 驗證學生證號格式
        function isValidStudentId(studentId) {
            // 8位數字或3位英文字母
            const pattern = /^(\d{8}|[A-Za-z]{3})$/;
            return pattern.test(studentId);
        }
        
        // 解析班別學號格式
        function parseClassNumber(input) {
            // 格式：班別 學號，如 "P1A 1" 或 "P1A 01"
            // 支持單數和雙數學號格式
            const pattern = /^([A-Za-z][0-9][A-Za-z])\s+([0-9]{1,2})$/;
            const match = input.match(pattern);
            
            if (match) {
                return {
                    class: match[1].toUpperCase(),
                    number: match[2] // 保持原樣，不進行補零
                };
            }
            return null;
        }
        
        // 載入映射文件
        function loadMappingFile() {
            const fileInput = document.getElementById('mapping-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('請選擇映射文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 假設使用第一個工作表
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: ['studentId', 'class', 'number']});
                    
                    // 跳過表頭
                    jsonData.shift();
                    
                    // 構建映射表
                    const newMapping = {};
                    const newReverseMapping = {};
                    let validCount = 0;
                    
                    jsonData.forEach(row => {
                        if (row.studentId && row.class && row.number) {
                            // 驗證學生證號格式
                            if (isValidStudentId(row.studentId)) {
                                // 將學號轉換為字符串，移除前導零
                                const numberStr = String(parseInt(row.number));
                                const classNumber = `${row.class} ${numberStr}`;
                                newMapping[row.studentId] = classNumber;
                                newReverseMapping[classNumber] = row.studentId;
                                
                                // 同時創建補零版本的反向映射
                                const numberPadded = numberStr.padStart(2, '0');
                                const classNumberPadded = `${row.class} ${numberPadded}`;
                                newReverseMapping[classNumberPadded] = row.studentId;
                                
                                validCount++;
                            }
                        }
                    });
                    
                    studentMapping = newMapping;
                    reverseMapping = newReverseMapping;
                    localStorage.setItem('studentMapping', JSON.stringify(studentMapping));
                    
                    updateMappingStatus();
                    updateReverseMapping();
                    showStatus(`成功載入 ${validCount} 條學生映射記錄`, 'success');
                } catch (error) {
                    console.error('解析Excel文件錯誤:', error);
                    showStatus('解析Excel文件失敗，請檢查文件格式', 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('讀取文件失敗', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 更新映射狀態顯示
        function updateMappingStatus() {
            const mappingStatus = document.getElementById('mapping-status');
            const count = Object.keys(studentMapping).length;
            
            if (count > 0) {
                mappingStatus.innerHTML = `<div class="status success">已載入 ${count} 條學生映射記錄</div>`;
            } else {
                mappingStatus.innerHTML = '<div class="status info">尚未載入學生映射文件</div>';
            }
        }
        
        // 更新反向映射
        function updateReverseMapping() {
            reverseMapping = {};
            for (const studentId in studentMapping) {
                const classNumber = studentMapping[studentId];
                reverseMapping[classNumber] = studentId;
                
                // 同時創建補零版本的反向映射
                const parts = classNumber.split(' ');
                if (parts.length === 2) {
                    const classPart = parts[0];
                    const numberPart = parts[1];
                    const numberPadded = numberPart.padStart(2, '0');
                    const classNumberPadded = `${classPart} ${numberPadded}`;
                    reverseMapping[classNumberPadded] = studentId;
                }
            }
        }
        
        // 根據學生編號獲取顯示名稱
        function getDisplayName(studentId) {
            return studentMapping[studentId] || studentId;
        }
        
        // 根據班別學號獲取學生證號
        function getStudentIdByClassNumber(classNumber) {
            return reverseMapping[classNumber] || null;
        }
        
        // 檢查學生是否已在當前活動中登記
        function isStudentAlreadyRegistered(studentId) {
            if (!currentSessionId || !attendanceData[currentSessionId]) {
                return false;
            }
            
            return attendanceData[currentSessionId].some(record => record.studentId === studentId);
        }
        
        // 清理數據：將學號從"01"格式改為"1"格式，並移除同一活動中重複的登記
        function cleanupData() {
            if (Object.keys(attendanceData).length === 0) {
                showStatus('暫無考勤記錄可清理', 'info');
                return;
            }
            
            if (!confirm('確定要清理數據嗎？此操作將：\n1. 將學號從"01"格式改為"1"格式\n2. 移除同一活動中重複的登記，只保留最晚的一個\n此操作不可恢復！')) {
                return;
            }
            
            let totalCleanedRecords = 0;
            let totalRemovedDuplicates = 0;
            
            // 遍歷所有活動
            for (const sessionId in attendanceData) {
                const sessionRecords = attendanceData[sessionId];
                
                if (!sessionRecords || sessionRecords.length === 0) {
                    continue;
                }
                
                // 用於跟蹤每個學生的最新記錄
                const latestRecords = {};
                const cleanedRecords = [];
                
                // 首先處理每條記錄，將學號格式標準化
                const processedRecords = sessionRecords.map(record => {
                    const cleanedRecord = {...record};
                    
                    // 處理學號：將"01"格式改為"1"格式
                    if (cleanedRecord.number) {
                        // 如果是數字字符串，移除前導零
                        if (/^\d+$/.test(cleanedRecord.number)) {
                            const originalNumber = cleanedRecord.number;
                            cleanedRecord.number = String(parseInt(cleanedRecord.number, 10));
                            
                            if (originalNumber !== cleanedRecord.number) {
                                totalCleanedRecords++;
                            }
                        }
                    }
                    
                    // 更新displayName以反映新的學號格式
                    if (cleanedRecord.class && cleanedRecord.number) {
                        cleanedRecord.displayName = `${cleanedRecord.class} ${cleanedRecord.number}`;
                    }
                    
                    return cleanedRecord;
                });
                
                // 按時間排序（從早到晚），以便保留最晚的記錄
                const sortedRecords = [...processedRecords].sort((a, b) => {
                    return new Date(a.timestamp) - new Date(b.timestamp);
                });
                
                // 遍歷排序後的記錄，保留每個學生的最新記錄
                for (const record of sortedRecords) {
                    const studentId = record.studentId;
                    
                    // 如果已經有該學生的記錄，用當前的記錄替換（因為是按時間排序的，所以後面的會更晚）
                    if (latestRecords[studentId]) {
                        totalRemovedDuplicates++;
                    }
                    
                    latestRecords[studentId] = record;
                }
                
                // 將最新的記錄轉換為數組
                const uniqueRecords = Object.values(latestRecords);
                
                // 按時間倒序排列（最新的在最前面）
                uniqueRecords.sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                // 更新該活動的記錄
                attendanceData[sessionId] = uniqueRecords;
            }
            
            // 保存到本地存儲
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // 更新UI
            updateSessionSelect();
            showSessionRecords();
            
            if (currentSessionId && attendanceData[currentSessionId]) {
                updateAttendanceList();
            }
            
            // 顯示清理結果
            const message = `數據清理完成！\n` +
                           `- 標準化 ${totalCleanedRecords} 個學號格式\n` +
                           `- 移除 ${totalRemovedDuplicates} 個重複登記`;
            
            showStatus(message, 'success');
        }
        
        // 開始掃描
        function startScanner() {
            currentSessionId = document.getElementById('session-id').value.trim();
            if (!currentSessionId) {
                showStatus('請輸入本次考勤識別碼', 'error');
                return;
            }
            
            // 初始化活動數據
            if (!attendanceData[currentSessionId]) {
                attendanceData[currentSessionId] = [];
            }
            
            scannedStudents.clear();
            updateAttendanceList();
            
            const videoContainer = document.getElementById('video-container');
            const scanResult = document.getElementById('scan-result');
            const startBtn = document.getElementById('start-scan');
            const stopBtn = document.getElementById('stop-scan');
            
            videoContainer.classList.remove('hidden');
            stopBtn.classList.remove('hidden');
            startBtn.classList.add('hidden');
            scanResult.innerHTML = '';
            
            isScanning = true;
            
            // 配置Quagga用於Code128條形碼掃描
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.getElementById('interactive'),
                    constraints: {
                        facingMode: "environment",
                        width: { min: 320, ideal: 640, max: 1280 },
                        height: { min: 120, ideal: 120, max: 240 },
                        aspectRatio: { min: 2, max: 4 }
                    }
                },
                decoder: {
                    readers: ["code_128_reader"]
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                locate: true,
                frequency: 10
            }, function(err) {
                if (err) {
                    console.error(err);
                    showStatus('條形碼掃描器初始化失敗: ' + err.message, 'error');
                    stopScanner();
                    return;
                }
                Quagga.start();
                
                // 强制设置扫描窗口尺寸
                setTimeout(() => {
                    const videoElement = document.querySelector('#interactive video');
                    const canvasElements = document.querySelectorAll('#interactive canvas');
                    
                    if (videoElement) {
                        videoElement.style.width = '100%';
                        videoElement.style.height = '120px';
                        videoElement.style.objectFit = 'cover';
                    }
                    
                    canvasElements.forEach(canvas => {
                        canvas.style.width = '100%';
                        canvas.style.height = '120px';
                    });
                }, 100);
                
                showStatus('Code128條形碼掃描器已啟動，請掃描學生證', 'info');
            });
            
            // 監聽條形碼檢測事件
            Quagga.onDetected(function(result) {
                if (!isScanning) return;
                
                const code = result.codeResult.code;
                processScannedCode(code);
            });
        }
        
        // 處理掃描到的條碼
        function processScannedCode(code) {
            const scanResult = document.getElementById('scan-result');
            
            // 驗證學生證號格式
            if (!isValidStudentId(code)) {
                scanResult.innerHTML = `<div class="status error">無效學生證號: ${code} (必須是8位數字)</div>`;
                setTimeout(() => {
                    scanResult.innerHTML = '';
                }, 3000);
                return;
            }
            
            const displayName = getDisplayName(code);
            
            // 檢查是否已經登記
            if (isStudentAlreadyRegistered(code)) {
                scanResult.innerHTML = `<div class="status info">已登記過: ${displayName}</div>`;
                setTimeout(() => {
                    scanResult.innerHTML = '';
                }, 2000);
                return;
            }
            
            // 記錄考勤
            const timestamp = new Date().toLocaleString('zh-TW');
            const record = {
                studentId: code,
                displayName: displayName,
                timestamp: timestamp,
                // 分離班別和學號
                class: null,
                number: null
            };
            
            // 如果有映射，分離班別和學號
            if (studentMapping[code]) {
                const classNumber = studentMapping[code];
                const parts = classNumber.split(' ');
                if (parts.length === 2) {
                    record.class = parts[0];
                    record.number = parts[1];
                }
            }
            
            // 將新記錄添加到數組開頭
            attendanceData[currentSessionId].unshift(record);
            
            // 保存到本地存儲
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            updateAttendanceList();
            updateSessionSelect();
            
            scanResult.innerHTML = `<div class="status success">已登記: ${displayName} - ${timestamp}</div>`;
            
            // 短暫顯示成功信息
            setTimeout(() => {
                scanResult.innerHTML = '';
            }, 2000);
        }
        
        // 手動提交學生編號
        function manualSubmit() {
            const manualInput = document.getElementById('manual-input');
            const input = manualInput.value.trim();
            
            if (!input) {
                showStatus('請輸入學生證號或班別學號', 'error');
                return;
            }
            
            if (!currentSessionId) {
                showStatus('請先輸入本次考勤識別碼', 'error');
                return;
            }
            
            // 初始化活動數據
            if (!attendanceData[currentSessionId]) {
                attendanceData[currentSessionId] = [];
            }
            
            let studentId = null;
            let displayName = null;
            
            // 檢查是否是學生證號格式
            if (isValidStudentId(input)) {
                studentId = input;
                displayName = getDisplayName(studentId);
            } 
            // 檢查是否是班別學號格式
            else {
                const parsed = parseClassNumber(input);
                if (parsed) {
                    // 嘗試多種格式查找
                    const formatsToTry = [
                        `${parsed.class} ${parsed.number}`, // 原始格式
                        `${parsed.class} ${parsed.number.padStart(2, '0')}`, // 補零格式
                    ];
                    
                    for (const format of formatsToTry) {
                        studentId = getStudentIdByClassNumber(format);
                        if (studentId) {
                            displayName = format;
                            break;
                        }
                    }
                    
                    if (!studentId) {
                        showStatus(`未找到對應的學生證號: ${parsed.class} ${parsed.number}，請先載入映射文件`, 'error');
                        return;
                    }
                } else {
                    showStatus(`無效輸入格式: ${input} (必須是8位數字 或 班別 學號，格式如: P1A 1)`, 'error');
                    return;
                }
            }
            
            // 檢查是否已經登記
            if (isStudentAlreadyRegistered(studentId)) {
                const scanResult = document.getElementById('scan-result');
                scanResult.innerHTML = `<div class="status info">已登記過: ${displayName}</div>`;
                setTimeout(() => {
                    scanResult.innerHTML = '';
                }, 2000);
                
                manualInput.value = '';
                return;
            }
            
            // 驗證學生證號格式
            if (!isValidStudentId(studentId)) {
                showStatus(`無效學生證號: ${studentId} (必須是8位數字)`, 'error');
                return;
            }
            
            // 記錄考勤
            const timestamp = new Date().toLocaleString('zh-TW');
            const record = {
                studentId: studentId,
                displayName: displayName,
                timestamp: timestamp,
                // 分離班別和學號
                class: null,
                number: null
            };
            
            // 解析班別和學號
            if (displayName.includes(' ')) {
                const parts = displayName.split(' ');
                if (parts.length === 2) {
                    record.class = parts[0];
                    // 移除前導零
                    record.number = String(parseInt(parts[1]));
                }
            }
            
            // 將新記錄添加到數組開頭
            attendanceData[currentSessionId].unshift(record);
            
            // 保存到本地存儲
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            updateAttendanceList();
            updateSessionSelect();
            
            const scanResult = document.getElementById('scan-result');
            scanResult.innerHTML = `<div class="status success">已登記: ${displayName} - ${timestamp}</div>`;
            
            // 短暫顯示成功信息
            setTimeout(() => {
                scanResult.innerHTML = '';
            }, 2000);
            
            manualInput.value = '';
        }
        
        // 停止掃描
        function stopScanner() {
            isScanning = false;
            
            const videoContainer = document.getElementById('video-container');
            const startBtn = document.getElementById('start-scan');
            const stopBtn = document.getElementById('stop-scan');
            
            Quagga.stop();
            
            videoContainer.classList.add('hidden');
            stopBtn.classList.add('hidden');
            startBtn.classList.remove('hidden');
            
            showStatus('掃描已停止', 'info');
        }
        
        // 更新考勤列表
        function updateAttendanceList() {
            const attendanceList = document.getElementById('attendance-list');
            
            if (attendanceData[currentSessionId] && attendanceData[currentSessionId].length > 0) {
                // 按時間倒序排列（最新的在最上面）
                const sortedRecords = [...attendanceData[currentSessionId]].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                attendanceList.innerHTML = '';
                
                // 添加表頭
                const header = document.createElement('div');
                header.className = 'record-item';
                header.innerHTML = `
                    <span>學生編號</span>
                    <span>登記時間</span>
                `;
                attendanceList.appendChild(header);
                
                sortedRecords.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-item';
                    item.innerHTML = `
                        <span>${record.displayName}</span>
                        <span>${record.timestamp}</span>
                    `;
                    attendanceList.appendChild(item);
                });
            } else {
                attendanceList.innerHTML = '<div class="status info">暫無考勤記錄</div>';
            }
        }
        
        // 更新活動選擇下拉框
        function updateSessionSelect() {
            const sessionSelect = document.getElementById('session-select');
            sessionSelect.innerHTML = '<option value="">-- 選擇活動 --</option>';
            
            Object.keys(attendanceData).forEach(sessionId => {
                const option = document.createElement('option');
                option.value = sessionId;
                option.textContent = sessionId;
                sessionSelect.appendChild(option);
            });
        }
        
        // 顯示活動記錄
        function showSessionRecords() {
            const sessionId = document.getElementById('session-select').value;
            const recordsList = document.getElementById('records-list');
            
            if (sessionId && attendanceData[sessionId]) {
                // 按時間倒序排列（最新的在最上面）
                const sortedRecords = [...attendanceData[sessionId]].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                recordsList.innerHTML = '';
                
                // 添加表頭
                const header = document.createElement('div');
                header.className = 'record-item';
                header.innerHTML = `
                    <span>學生編號</span>
                    <span>登記時間</span>
                `;
                recordsList.appendChild(header);
                
                sortedRecords.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-item';
                    item.innerHTML = `
                        <span>${record.displayName}</span>
                        <span>${record.timestamp}</span>
                    `;
                    recordsList.appendChild(item);
                });
                
                // 顯示統計信息
                const count = document.createElement('div');
                count.className = 'status info';
                count.textContent = `共 ${sortedRecords.length} 條記錄`;
                recordsList.appendChild(count);
            } else {
                recordsList.innerHTML = '<div class="status info">請選擇活動或該活動暫無記錄</div>';
            }
        }
        
        // 班別排序函數：按照 P1A-P6E 的順序
        function sortClass(classA, classB) {
            if (!classA || !classB) return 0;
            
            // 提取年級和班級字母
            const gradeA = parseInt(classA.substring(1, 2));
            const letterA = classA.substring(2, 3);
            const gradeB = parseInt(classB.substring(1, 2));
            const letterB = classB.substring(2, 3);
            
            // 先比較年級
            if (gradeA !== gradeB) {
                return gradeA - gradeB;
            }
            
            // 同年級比較班級字母
            return letterA.localeCompare(letterB);
        }
        
        // 學號排序函數：按照數字大小
        function sortNumber(numberA, numberB) {
            if (!numberA || !numberB) return 0;
            
            const numA = parseInt(numberA) || 0;
            const numB = parseInt(numberB) || 0;
            
            return numA - numB;
        }
        
        // 匯出為Excel
        function exportToExcel() {
            if (Object.keys(attendanceData).length === 0) {
                showStatus('暫無考勤記錄可匯出', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const usedSheetNames = {}; // 用於追踪已使用的工作表名稱
            
            // 為每個活動創建一個工作表
            Object.keys(attendanceData).forEach(sessionId => {
                const records = attendanceData[sessionId];
                const wsData = [
                    ['學生證號 (後台識別)', '班別', '學號', '登記時間']  // 表頭
                ];
                
                // 過濾掉沒有班別和學號的記錄（用於排序）
                const recordsWithClassNumber = records.filter(record => record.class && record.number);
                const recordsWithoutClassNumber = records.filter(record => !record.class || !record.number);
                
                // 按班別（P1A-P6E）和學號（小到大）排序
                const sortedRecords = [...recordsWithClassNumber].sort((a, b) => {
                    // 先按班別排序
                    const classCompare = sortClass(a.class, b.class);
                    if (classCompare !== 0) return classCompare;
                    
                    // 班別相同則按學號排序
                    return sortNumber(a.number, b.number);
                });
                
                // 將沒有班別和學號的記錄添加到最後
                const finalRecords = [...sortedRecords, ...recordsWithoutClassNumber];
                
                finalRecords.forEach(record => {
                    // 確保有班別和學號
                    const className = record.class || '';
                    const number = record.number || '';
                    
                    wsData.push([
                        record.studentId,  // 學生證號 (後台識別)
                        className,          // 班別
                        number,             // 學號
                        record.timestamp    // 登記時間
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 清理工作表名稱中的非法字符
                let sheetName = sessionId.substring(0, 31); // Excel工作表名最多31字符
                sheetName = sheetName.replace(/[:\\\/?*[\]]/g, '_'); // 替換非法字符為下劃線
                
                // 如果工作表名稱為空，使用默認名稱
                if (!sheetName.trim()) {
                    sheetName = `Session_${Object.keys(attendanceData).indexOf(sessionId) + 1}`;
                }
                
                // 確保工作表名稱唯一
                let originalName = sheetName;
                let counter = 1;
                while (usedSheetNames[sheetName]) {
                    sheetName = `${originalName}_${counter}`;
                    // 確保不超過31個字符
                    sheetName = sheetName.substring(0, 31);
                    counter++;
                }
                
                usedSheetNames[sheetName] = true;
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            // 生成並下載Excel文件
            const fileName = `考勤記錄_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showStatus('Excel文件已生成並開始下載', 'success');
        }
        
        // 重命名活動
        function renameSession() {
            const sessionSelect = document.getElementById('session-select');
            const oldSessionId = sessionSelect.value;
            
            if (!oldSessionId) {
                showStatus('請先選擇要重命名的活動', 'error');
                return;
            }
            
            // 創建對話框
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'dialog-overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            
            dialog.innerHTML = `
                <h3>重命名活動</h3>
                <div class="form-group">
                    <label for="new-session-name">新活動名稱</label>
                    <input type="text" id="new-session-name" value="${oldSessionId}" placeholder="請輸入新活動名稱">
                </div>
                <div class="dialog-buttons">
                    <button id="cancel-rename" class="secondary">取消</button>
                    <button id="confirm-rename" class="secondary">確認重命名</button>
                </div>
            `;
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
            
            // 設置焦點到輸入框
            setTimeout(() => {
                document.getElementById('new-session-name').focus();
            }, 100);
            
            // 取消按鈕事件
            document.getElementById('cancel-rename').addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
            });
            
            // 確認按鈕事件
            document.getElementById('confirm-rename').addEventListener('click', function() {
                const newSessionId = document.getElementById('new-session-name').value.trim();
                
                if (!newSessionId) {
                    showStatus('新活動名稱不能為空', 'error');
                    return;
                }
                
                if (newSessionId === oldSessionId) {
                    showStatus('新活動名稱與原名稱相同', 'info');
                    document.body.removeChild(dialogOverlay);
                    return;
                }
                
                if (attendanceData[newSessionId]) {
                    showStatus('活動名稱已存在，請使用其他名稱', 'error');
                    return;
                }
                
                // 重命名活動
                attendanceData[newSessionId] = attendanceData[oldSessionId];
                delete attendanceData[oldSessionId];
                
                // 更新本地存儲
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // 更新UI
                updateSessionSelect();
                showSessionRecords();
                
                // 如果當前活動是正在掃描的活動，更新currentSessionId
                if (currentSessionId === oldSessionId) {
                    currentSessionId = newSessionId;
                    document.getElementById('session-id').value = newSessionId;
                    updateAttendanceList();
                }
                
                // 選擇新活動
                document.getElementById('session-select').value = newSessionId;
                
                showStatus(`活動已重命名為: ${newSessionId}`, 'success');
                document.body.removeChild(dialogOverlay);
            });
            
            // 回車鍵確認
            document.getElementById('new-session-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-rename').click();
                }
            });
            
            // 點擊背景關閉
            dialogOverlay.addEventListener('click', function(e) {
                if (e.target === dialogOverlay) {
                    document.body.removeChild(dialogOverlay);
                }
            });
        }
        
        // 刪除活動
        function deleteSession() {
            const sessionSelect = document.getElementById('session-select');
            const sessionId = sessionSelect.value;
            
            if (!sessionId) {
                showStatus('請先選擇要刪除的活動', 'error');
                return;
            }
            
            // 創建對話框
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'dialog-overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            
            dialog.innerHTML = `
                <h3>刪除活動</h3>
                <div class="form-group">
                    <p>確定要刪除活動 <strong>"${sessionId}"</strong> 嗎？</p>
                    <p>此操作將刪除該活動的所有考勤記錄，且無法恢復。</p>
                </div>
                <div class="dialog-buttons">
                    <button id="cancel-delete" class="secondary">取消</button>
                    <button id="confirm-delete" class="danger">確認刪除</button>
                </div>
            `;
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
            
            // 取消按鈕事件
            document.getElementById('cancel-delete').addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
            });
            
            // 確認按鈕事件
            document.getElementById('confirm-delete').addEventListener('click', function() {
                // 刪除活動
                delete attendanceData[sessionId];
                
                // 更新本地存儲
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // 更新UI
                updateSessionSelect();
                document.getElementById('records-list').innerHTML = '<div class="status info">活動已刪除</div>';
                
                // 如果當前活動是被刪除的活動，清空currentSessionId
                if (currentSessionId === sessionId) {
                    currentSessionId = '';
                    document.getElementById('session-id').value = '';
                    updateAttendanceList();
                }
                
                showStatus(`活動 "${sessionId}" 已刪除`, 'success');
                document.body.removeChild(dialogOverlay);
            });
            
            // 點擊背景關閉
            dialogOverlay.addEventListener('click', function(e) {
                if (e.target === dialogOverlay) {
                    document.body.removeChild(dialogOverlay);
                }
            });
        }
        
        // 生成參與次數統計
        function generateAttendanceStats() {
            const fileInput = document.getElementById('stats-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('請選擇考勤Excel文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 重置統計數據
                    statsData = {
                        students: {},
                        sessions: workbook.SheetNames.length,
                        sessionNames: workbook.SheetNames,
                        summary: {}
                    };
                    
                    let totalAttendance = 0;
                    
                    // 遍歷每個工作表（每個活動）
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // 跳過表頭行
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 3) {
                                const studentClass = row[1] || ''; // 班別
                                const studentNumber = row[2] || ''; // 學號
                                
                                if (studentClass && studentNumber) {
                                    const studentKey = `${studentClass} ${studentNumber}`;
                                    
                                    // 初始化學生數據
                                    if (!statsData.students[studentKey]) {
                                        statsData.students[studentKey] = {
                                            class: studentClass,
                                            number: studentNumber,
                                            count: 0,
                                            attendedSessions: [] // 參與的活動代碼列表
                                        };
                                        
                                        // 初始化班級統計
                                        if (!statsData.summary[studentClass]) {
                                            statsData.summary[studentClass] = {
                                                studentCount: 0,
                                                totalAttendance: 0,
                                                students: []
                                            };
                                        }
                                        statsData.summary[studentClass].studentCount++;
                                        statsData.summary[studentClass].students.push(studentKey);
                                    }
                                    
                                    // 增加參與次數
                                    statsData.students[studentKey].count++;
                                    
                                    // 記錄參與的活動代碼（如果尚未記錄）
                                    if (!statsData.students[studentKey].attendedSessions.includes(sheetName)) {
                                        statsData.students[studentKey].attendedSessions.push(sheetName);
                                    }
                                    
                                    statsData.summary[studentClass].totalAttendance++;
                                    totalAttendance++;
                                }
                            }
                        }
                    });
                    
                    // 顯示統計結果
                    displayStats();
                    showStatus(`成功分析 ${statsData.sessions} 個活動，共 ${Object.keys(statsData.students).length} 名學生的參與記錄`, 'success');
                } catch (error) {
                    console.error('解析統計文件錯誤:', error);
                    showStatus('解析統計文件失敗，請檢查文件格式', 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('讀取文件失敗', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 顯示統計結果
        function displayStats() {
            const statsResult = document.getElementById('stats-result');
            const statsContainer = document.getElementById('stats-container');
            const exportStatsBtn = document.getElementById('export-stats');
            
            // 顯示統計區域
            statsResult.classList.remove('hidden');
            exportStatsBtn.classList.remove('hidden');
            
            // 清空容器
            statsContainer.innerHTML = '';
            
            // 按班別排序
            const sortedClasses = Object.keys(statsData.summary).sort(sortClass);
            
            // 為每個班別創建表格
            sortedClasses.forEach(className => {
                const classData = statsData.summary[className];
                
                // 創建班別標題
                const classTitle = document.createElement('h4');
                classTitle.textContent = `班別: ${className} (${classData.studentCount} 名學生)`;
                classTitle.style.marginTop = '20px';
                classTitle.style.marginBottom = '10px';
                classTitle.style.color = '#1a73e8';
                statsContainer.appendChild(classTitle);
                
                // 創建表格
                const table = document.createElement('table');
                table.className = 'stats-table';
                
                // 創建表頭
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>學號</th>
                        <th>參與次數</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // 創建表體
                const tbody = document.createElement('tbody');
                
                // 按學號排序
                const sortedStudents = classData.students.sort((a, b) => {
                    const numA = parseInt(statsData.students[a].number) || 0;
                    const numB = parseInt(statsData.students[b].number) || 0;
                    return numA - numB;
                });
                
                // 添加學生數據行
                sortedStudents.forEach(studentKey => {
                    const student = statsData.students[studentKey];
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.number}</td>
                        <td>${student.count}</td>
                    `;
                    
                    // 根據參與次數添加顏色標識
                    if (student.count === statsData.sessions) {
                        row.style.backgroundColor = '#e6f4ea'; // 全勤
                    } else if (student.count >= statsData.sessions * 0.7) {
                        row.style.backgroundColor = '#fef7e0'; // 高參與率
                    }
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                statsContainer.appendChild(table);
            });
            
            // 如果沒有數據
            if (sortedClasses.length === 0) {
                statsContainer.innerHTML = '<div class="status info">未找到有效的考勤數據</div>';
            }
        }
        
        // 匯出統計結果為Excel
        function exportStatsToExcel() {
            if (Object.keys(statsData.students).length === 0) {
                showStatus('暫無統計數據可匯出', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // 創建詳細統計工作表
            const detailedData = [
                ['班別', '學號', '參與次數', '參與活動代碼']  // 表頭
            ];
            
            // 按班別和學號排序
            const sortedStudents = Object.keys(statsData.students).sort((a, b) => {
                const studentA = statsData.students[a];
                const studentB = statsData.students[b];
                
                // 先按班別排序
                const classCompare = sortClass(studentA.class, studentB.class);
                if (classCompare !== 0) return classCompare;
                
                // 班別相同則按學號排序
                return sortNumber(studentA.number, studentB.number);
            });
            
            // 添加詳細數據
            sortedStudents.forEach(key => {
                const student = statsData.students[key];
                // 將參與活動代碼列表轉換為逗號分隔的字符串
                const attendedSessionsStr = student.attendedSessions.join(', ');
                
                detailedData.push([
                    student.class,
                    student.number,
                    student.count,
                    attendedSessionsStr
                ]);
            });
            
            const detailedWs = XLSX.utils.aoa_to_sheet(detailedData);
            XLSX.utils.book_append_sheet(wb, detailedWs, '參與次數統計');
            
            // 生成並下載Excel文件
            const fileName = `參與次數統計_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showStatus('統計結果Excel文件已生成並開始下載', 'success');
        }
        
        // 清除所有數據
        function clearAllData() {
            if (confirm('確定要清除所有考勤數據嗎？此操作不可恢復！')) {
                attendanceData = {};
                localStorage.removeItem('attendanceData');
                updateSessionSelect();
                document.getElementById('records-list').innerHTML = '<div class="status info">數據已清除</div>';
                document.getElementById('attendance-list').innerHTML = '<div class="status info">暫無考勤記錄</div>';
                showStatus('所有數據已清除', 'success');
            }
        }
        
        // 顯示狀態信息
        function showStatus(message, type) {
            // 移除現有的狀態信息
            const existingStatus = document.querySelector('.status');
            if (existingStatus && existingStatus.parentNode === document.body) {
                existingStatus.remove();
            }
            
            // 創建新的狀態信息
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            
            // 插入到頁面頂部
            document.body.insertBefore(status, document.querySelector('header'));
            
            // 5秒後自動移除
            setTimeout(() => {
                if (status.parentNode) {
                    status.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
